#!/usr/bin/env python
"""
Demonstration of how the input can be indented.
"""
import json

import click
import moz_sql_parser
import Levenshtein

from pygments.lexers import JsonLexer
from pygments.styles import get_style_by_name

from prompt_toolkit.styles.pygments import style_from_pygments_cls
from prompt_toolkit.lexers import PygmentsLexer
from prompt_toolkit.shortcuts import PromptSession, print_formatted_text
from prompt_toolkit.history import FileHistory
from prompt_toolkit.formatted_text import HTML, PygmentsTokens
from prompt_toolkit.key_binding import KeyBindings

import sql
import backends
from pager import pager

json_lexer = JsonLexer()
style = style_from_pygments_cls(get_style_by_name("monokai"))


def render(output):
    dump = json.dumps(output, indent=4)
    tokens = list(json_lexer.get_tokens(dump))

    with pager(options="-FRSX") as less:
        print_formatted_text(
            PygmentsTokens(tokens),
            style=style,
            file=less,
        )


@click.command()
@click.option("--url", type=str, required=True)
@click.option("--type", type=str, default=None)
@click.option("--debug", is_flag=True, default=False)
def main(url, type, debug):
    backend = backends.load(type, url, debug)
    completer = sql.SQLCompleter(tables=backend.get_tables())

    bindings = KeyBindings()

    @bindings.add(" ")
    def _(event):
        buffer = event.app.current_buffer
        word = buffer.document.get_word_before_cursor()
        if word is not None:
            for comp in sql.keywords:
                if Levenshtein.ratio(word.lower(), comp.lower()) >= 0.75:
                    buffer.delete_before_cursor(count=len(word))
                    buffer.insert_text(comp)
                    break
        buffer.insert_text(" ")

    history = FileHistory(".pt_esql_history")
    session = PromptSession(
        ">",
        lexer=PygmentsLexer(sql.SQLLexer),
        completer=completer,
        complete_while_typing=False,
        history=history,
        validator=sql.SQLValidator(),
        validate_while_typing=False,
        bottom_toolbar=HTML(f"{backend.name}: <b>{url}</b>"),
        key_bindings=bindings,
        style=style,
    )

    while True:
        try:
            stmt = session.prompt("eSQL> ").rstrip(";")
            if not stmt.strip():
                continue

            ir_dct = moz_sql_parser.parse(stmt)
            result = backend.query(ir_dct)
            render(result)

        except EOFError:
            break


if __name__ == "__main__":
    main()
